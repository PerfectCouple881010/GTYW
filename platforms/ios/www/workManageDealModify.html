﻿<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv = "X-UA-Compatible" content = "IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=yes" /> 
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<title>贯通综合管理系统-工作管理—协议修改</title>
<link href="css/mui.min.css" rel="stylesheet" />
<link href="css/mui.indexedlist.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="css/app.css" />
<link rel="stylesheet" type="text/css" href="css/base.css">
<link rel="stylesheet" type="text/css" href="css/main.css">
<script type="text/javascript" src="js/jquery-1.7.1.js"></script>
<link href="css/mobiscroll.min.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="sweetalert-master/css/sweetalert.css">
<script type="text/javascript" src="sweetalert-master/js/sweetalert.min.js"></script>
<style type="text/css">  
.upload_process_bar{  
    width:100%;  
    border:#ccc 1px solid;  
    height:6px;  
    padding:1px;  
    background:#fff;  
    -moz-border-radius:10px;  
    -webkit-border-radius:10px;  
    border-radius:10px;  
    display:none;  
}  
.upload_current_process{  
    height:6px;  
    width:0%;  
    background:#A4C639;  
    -moz-border-radius:10px;  
    -webkit-border-radius:10px;  
    border-radius:10px;      
}  
</style>
<style>
.mui-bar {
	-webkit-box-shadow: none;
	box-shadow: none;
}

#done.mui-disabled {
	color: gray;
}

.mui-table-view-cell.mui-checkbox input[type=checkbox],.mui-table-view-cell.mui-radio input[type=radio] {
	top: 16px;
}
</style>
<!-- <link href="css/common.css" rel="stylesheet" type="text/css" /> -->

</head>
<body>
<div id="offCanvasWrapper" class="mui-off-canvas-wrap mui-draggable">
	<!--侧滑菜单部分-->
	<aside id="offCanvasSide" class="  mui-off-canvas-right" style="background: none">
			<header class="mui-bar mui-bar-nav">
				<a class=" mui-icon mui-icon-left-nav mui-pull-left" id="offCanvasHide"></a>
				<span id="zhHead"></span>
			</header>	
			<div id="offCanvasSideScroll" class="mui-scroll-wrapper">
				<div class="mui-scroll">				
					<div class="mui-content">
						<div id='list' class="mui-indexed-list">
							<div class="mui-indexed-list-search mui-input-row mui-search">
								<input type="search" class="mui-input-clear mui-indexed-list-search-input" placeholder="请输入搜索内容">
							</div>
							<div class="mui-indexed-list-alert"></div>
							<div class="mui-indexed-list-inner">
								<div class="mui-indexed-list-empty-alert">没有数据</div>
								<ul class="mui-table-view" id ="ryList">
									<li class="mui-table-view-cell mui-indexed-list-item mui-checkbox mui-media mui-left">
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</aside>
		<div class="mui-inner-wrap">
<header class="mui-bar mui-bar-nav">
   <!--  <a class="headerL" href="javascript:history.go(-1);"><img src="images/return.png"></a> -->
    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
    <h1 class="mui-title"> 协议修改 </h1>
    <!-- <a class="headerL" href="workManageDeal.html"><img src="images/return.png"></a>
    协议修改 -->
</header>
<div id="offCanvasContentScroll" class="mui-content mui-scroll-wrapper">
				<div class="mui-scroll">
					<div class="mui-content-padded">
		<form class="mui-input-group" id="addJhForm">
            <div class="mui-input-row">
               <label><span style="color:red">*</span> 协议名称</label>
               <input type="text" id="name" placeholder="请输入协议名称" validate="*" errorMsg="协议名称必填"/>
            </div>
            <div class="mui-input-row">
   	   			<label><span style="color:red">*</span> 所属会谈</label>
              <select id="planTalkId" class="select" validate="*" errorMsg="所属会谈必填">
              </select>
              <input type="hidden" id="pid"/>      
            </div>
            <div class="mui-input-row">
               <label><span style="color:red">*</span> 协议类型</label>
                <select id="dealType" class="select" validate="*" errorMsg="协议类型必填">
                </select>  
            </div>
            <div class="mui-input-row">
                 <label><span style="color:red">*</span> 签署时间</label>
                 <input type="text" class="kbtn" id="signDate" placeholder="请输入签署时间" validate="*" errorMsg="签署时间必填" /> 
                 
            </div>
			<div class="mui-input-row" id="offCanvasShowQSR" >
            	<label><span style="color:red">*</span> 签 署 人</label>
            	<input type="text" class="mui-input  " id="customerSignerName" value="" readonly="readonly" placeholder="请选择所属会谈" validate="*" errorMsg="所属会谈必填">
               <input id="customerSigner" type="hidden"  name="customerSigner"  value="" />
               <!-- <a class="mui-navigate-right" id="offCanvasShowQSR"  /></a>  -->
               <!-- <input type="text" id="customerSigner" placeholder="请输入签署人"  validate="*" errorMsg="签署人必填"/> -->
            </div>
             <div class="mui-input-row">
                 <label><span style="color:red"></span>附件</label>
                 <input type="hidden" class="kbtn" id="dealFile1" placeholder="请选择附件上传" readonly="readonly"/> 
            </div>
           <div  id="show1"></div>
            <div id="box" class="DetailBot borderBot2" >
            	<div class="add" style=" min-height:100px; margin-top:20px;">
            	   <div class="upload_process_bar">  
						 <div class="upload_current_process"></div>  
					 </div>  
				 <div id="process_info"></div> 
				 <a href="javascript:void(0)" class="header_button" style="color:#000;" id="album">来自相册</a>
				 <img  
					style="width: 160px; height: 160px;" id="smallImage"  
					src="" title=""/>
					<a href="javascript:void(0)" id="uploadFile"  style="color:#000;" data-role="button">上传图片</a>
					<input type="hidden" id="dealFile" name="dealFile" value="">
				</div>
   			 </div>
   			
            <div class="mui-input-row">
			   <label><span style="color:red">*</span> 盖章时间</label>
               <input type="text" class="kbtn" placeholder="请输入盖章时间" id="sealDate" validate="*" errorMsg="盖章时间必填"/>
            </div>
			<div class="mui-input-row">
			  <label><span style="color:red">*</span> 生效时间</label>
               <input type="text" class="kbtn" placeholder="请输入合同生效时间" id="effectiveTime" validate="*" errorMsg="合同生效时间必填"/>
            </div>
		    <div class="mui-input-row">
			  <label><span style="color:red">*</span> 期限/月</label>
              <input type="text"  class="kbtn" id="period" placeholder="以整数月位单位" validate="nn" errorMsg="期限必须是整数"/>
            </div>
        
        <div class="mui-input-row">
        	<label>协议描述</label>
        </div>
            <textarea placeholder="请输入详细协议描述" id="description"></textarea>
    <div class="mui-button-row" style="height:57px">
		<div class="DetailBotBtn1 DetailBotBtn2">       
			<a  class="back header_button  mui-action-back">取消修改</a>
			<a href="javascript:void(0);" class="newproject header_button" id="tijiao">确认修改</a>
		</div>
	</div>
    <!-- <div class="DetailBotBtn1 DetailBotBtn2">
        <a href="workManageDeal.html" id="cancelAdd">取消修改</a>
        <a href="#2" id="wancheng">确认修改</a>
    </div> -->
    
</form>
</div></div></div></div></div>

<script type="text/javascript" src="js/jquery.js"></script>
<!-- <script type="text/javascript" src="js/date.js" ></script> -->
<script type="text/javascript" src="js/iscroll.js" ></script>
<script src="js/mobiscroll.min.js"></script>
<script>
$(function(){
	$('#signDate').mobiscroll().datetime({theme: 'android-holo-light', lang: 'zh',display: 'bottom'});
	$('#sealDate').mobiscroll().datetime({theme: 'android-holo-light', lang: 'zh',display: 'bottom'});
	$('#effectiveTime').mobiscroll().datetime({theme: 'android-holo-light', lang: 'zh',display: 'bottom'});
});
</script>
<script src="lib/jquery-2.1.4.min.js"></script>
<script src="js/mui.min.js"></script>
<script src="js/mui.indexedlist.js"></script>
<script src="js/app.js"></script>
<script type="text/javascript" src="js/index.js"></script>
<script type="text/javascript" src="js/initInfo.js"></script>
<script type="text/javascript" src="diyUpload/js/webuploader.html5only.min.js"></script>
<script type="text/javascript" src="diyUpload/js/MuidiyUpload.js"></script>
 <!-- Mobiscroll JS and CSS Includes -->
<script src="js/mobiscroll.min.js"></script>
<script type="text/javascript">
mui.init();
//$(function () {});
		mui.ready(function() {
		intiBaseByType(serverIp,"sid","currentIntent","/dataDir/listName.do","yxz");
var userId =localStorage.getItem("id");
		$('#chargerNameId').val(userId);
		//getxmList();
	  //侧滑容器父节点
		var offCanvasWrapper = mui('#offCanvasWrapper');
		 //主界面容器
		var offCanvasInner = offCanvasWrapper[0].querySelector('.mui-inner-wrap');
		 //菜单容器
		var offCanvasSide = document.getElementById("offCanvasSide");
		if (!mui.os.android) {
			var spans = document.querySelectorAll('.android-only');
			for (var i = 0, len = spans.length; i < len; i++) {
				spans[i].style.display = "none";
			}
		}
		
		//主界面‘显示侧滑菜单’按钮的点击事件 ---签署人
		document.getElementById('offCanvasShowQSR').addEventListener('tap', function() {
			var title='<h1 class="mui-title">选择签署人</h1>'+
			'<a id="done" class="mui-btn mui-btn-link mui-pull-right mui-btn-blue mui-disabled">完成</a>';
			document.querySelector('#zhHead').innerHTML = title;
			gethtList();
			offCanvasWrapper.offCanvas('show');
			var header = document.querySelector('header.mui-bar');
			var list = document.getElementById('list');
			var done = document.getElementById('done');
			//calc hieght
			//list.style.height =(document.body.offsetHeight - header.offsetHeight) + 'px';
			list.style.height = '100%';
			//create
			window.indexedList = new mui.IndexedList(list);
			//done event
			done.addEventListener('tap', function() {
				var customerSigner = $("input[name='radio']:checked").val();
				var customerSignerName = $("input[name='radio']:checked").attr("ryname");
				if (customerSigner > 0) {
				document.getElementById('customerSignerName').value=customerSignerName;
				document.getElementById('customerSigner').value=customerSigner;
				offCanvasWrapper.offCanvas('close');
				 } else {
					mui.swal('你没选择任何签署人');
				}
				
			}, false);
			mui('.mui-indexed-list-inner').on('change', 'input', function() {
				var count = list.querySelectorAll('input[type="radio"]:checked').length;
				var value = count ? "完成(" + count + ")" : "完成";
				done.innerHTML = value;
				//mui.alert('你选择了: ' + radiovalue );
				if (count) {
					if (done.classList.contains("mui-disabled")) {
						done.classList.remove("mui-disabled");
					}
				} else {
					if (!done.classList.contains("mui-disabled")) {
						done.classList.add("mui-disabled");
					}
				}
			});
		});
		
		 //菜单界面，‘关闭侧滑菜单’按钮的点击事件//
		document.getElementById('offCanvasHide').addEventListener('tap', function() {
			offCanvasWrapper.offCanvas('close');
		});

intiBaseDic(serverIp,"pid","planTalkId","/planTalk/listIntentName.do");//planTalkId
intiBaseByType(serverIp,"dtid","dealType","/dataDir/listName.do","xylx");
//intiBaseByType(serverIp,"dsid","dealStatus","/dataDir/listName.do","xyzt");
		var id = location.href.split('?')[1].split('=')[1];
		
		$.ajax({
			type:'post',
			url: 'http://'+serverIp+'/gtims/deal/editForPhone.do',
			data: {'id':id},
			dataType: 'json',
			crossDomain: true,	
			success: function(data) {				
				$('#name').val(data.name);
				$('#description').val(data.description);
				$('#planTalkId').val(data.planTalkId);
				$('#dealType').val(data.dealType);
				$('#dealWrite').val(data.dealWrite);
				$('#writeDate').val(data.writeDate);
				$('#dealStatus').val(data.dealStatus);
				$('#customerSigner').val(data.customerSigner);
				$('#customerSignerName').val(data.customerSignerShow);
				$('#signDate').val(data.signDate);
				$('#sealDate').val(data.sealDate);
				var result="";
				var fileUrl = "";
				if(data.dealFile!=null && data.dealFile!=""){
					for(var i=0;i<data.dealFile.length;i++){
						result+='&nbsp;&nbsp;&nbsp;<a style="color:#FF9D2F" href="http://'+serverIp+'/gtims'+data.dealFile[i]+'">'+"文件名:&nbsp;"+data.dealFile[i].substring(data.dealFile[i].lastIndexOf("/")+1)+'<br>'
						fileUrl+=data.dealFile[i]+",";
					}
					$('#show1').append(result);
					document.getElementById("dealFile").value=fileUrl.substring(0,fileUrl.length-1);
				}
				$('#note').val(data.note);
				$('#effectiveTime').val(data.effectiveTime);
				$('#period').val(data.period);
			},
			error:function(msg){
				swal("访问出错！");
			}
		});
		 var tjButton = document.getElementById('tijiao');
	        tjButton.addEventListener('tap', function(event) {
			var userId =localStorage.getItem("id");
				//validateForm验证
				var result = true;
				$("form input[type='text']").each(function(){
					if($(this).attr("validate")!=null&&!validateForm($(this))){
						result = false;
						return result;
					}
					
				});
				if(result != false){
				$("select").each(function(){
					if($(this).attr("validate")!=null&&!validateForm($(this))){
						result = false;
						return result;
					}
				});}
			if(result){
			$.ajax({
				type:'post',
				url: 'http://'+serverIp+'/gtims/deal/updateForPhone.do',
				header:{
					'Access-Control-Allow-Origin':'*'
				},
				data: {
					'modifyPersonId':userId,'id':id,
					'name':$('#name').val(),
					'planTalkId':$('#planTalkId').val(),
					'dealType':$('#dealType').val(),
					'dealWrite':$('#dealWrite').val(),
					'customerSigner':$('#customerSigner').val(),
					'signDate':$('#signDate').val(),
					'sealDate':$('#sealDate').val(),
					//'dealFile':$('#dealFile').val(),
					'dealFile':$('#dealFile').val(),
					'effectiveTime':$('#effectiveTime').val(),
					'period':$('#period').val(),
					'description':$('#description').val()

				},
				dataType: 'json',
				crossDomain: true,	
				success: function(data) {
					location.href='workManageDeal.html?code=&id=';
				},
				error:function(msg){
					swal("访问出错！");
				}
			});
			}
		});
	        
	        //participants.value = userName ;
	      	 //主界面和侧滑菜单界面均支持区域滚动；
	      			mui('#offCanvasSideScroll').scroll();
	      			mui('#offCanvasContentScroll').scroll();
	      			 //实现ios平台原生侧滑关闭页面；
	      			if (mui.os.plus && mui.os.ios) {
	      				mui.plusReady(function() { //5+ iOS暂时无法屏蔽popGesture时传递touch事件,直接屏蔽popGesture功能
	      					plus.webview.currentWebview().setStyle({
	      						'popGesture': 'none'
	      					});
	      				});
	      			}
	      			
	      			});
	   		//查询签署人 	
	   		function gethtList() {
	   			var customerSigner = $('#customerSigner').val(); 
	   			$.ajax({
	   		url: 'http://'+serverIp+'/gtims/linkman/list.do?userId='+localStorage.getItem("id"),
	   		async: false,
	   		data:{'start':'0','end':'10000'},
	   		dataType: 'json',
	   		crossDomain: true,
	   		success: function(data) {
	   		 var html = "",obj=data.data;
	   			for (var i = 0; i < obj.length; i++) {
	   			    html+='<li class="mui-table-view-cell mui-indexed-list-item mui-radio mui-media mui-left">'+
	   				'<input type="radio"  name="radio"  value="'+obj[i].id+'" ryname="'+obj[i].name+'" ';
	   					if(obj[i].id==customerSigner){
	   						html+=' checked="checked" ';
	   					}			
	   				html+=' /><div class="mui-media-body mui-ellipsis">'+obj[i].name+'('+obj[i].address+')'+
	   									'<p class="mui-ellipsis">'+obj[i].phoneMobile+'</p>'+
	   								'</div></li>';
	   			}
	   		document.querySelector('#ryList').innerHTML = html;
	   	}
	   	});
	   		}

	   		var file=document.getElementById("dealFile").value;
			$('#upload').diyUpload({
				url:'http://'+serverIp+'/gtims/fileUpload/upload.do?ctype=fybx',
				success:function( data ) {
					for(var i=0;i<data.length;i++){
						if(file.length==0){
							file+=data[i].url;
							}
							else{
							file=file+",";
							file+=data[i].url;
							}
						console.info(data[i].url);
					}
					document.getElementById("dealFile").value=file;
				},
				error:function( err ) {
					console.info( err );	
				}
			});		
</script>

<script type="text/javascript" charset="utf-8" src="cordova.js"></script>  
<script type="text/javascript" charset="utf-8">   
    document.addEventListener("deviceready", onDeviceReady, false);  
    var pictureSource; //  getPicture:数据来源参数的一个常量  
    var destinationType; // getPicture中：设置getPicture的结果类型  
    var mediaType;//允许上传的文件类型
    function onDeviceReady() {  
         pictureSource = navigator.camera.PictureSourceType; 
         destinationType = navigator.camera.DestinationType;  
         mediaType = navigator.camera.MediaType.ALLMEDIA; //允许所有的类型上传
    }

    /** 
	 * 上传成功回调. 
	 * @param r 
	 */  
	function uploadSuccess(r) {  
	   // swal('文件上传成功:'+r.response);
	    var result = eval(r.response);
		//swal(JSON.stringify(result[0]));
		document.getElementById("dealFile").value=result[0].url;
	    clearProcess();  
	}
	
	/** 
	 * 上传失败回调. 
	 * @param error 
	 */  
	function uploadFailed(error) {  
	    swal('上传失败了。');  
	    clearProcess();  
	} 
	
/** 
 * 上传过程回调，用于处理上传进度，如显示进度条等。 
 */  
function uploadProcessing(progressEvent){  
      
    if (progressEvent.lengthComputable) {  
        //已经上传  
        var loaded=progressEvent.loaded;  
        //文件总长度  
        var total=progressEvent.total;  
        //计算百分比，用于显示进度条  
        var percent=parseInt((loaded/total)*100);  
        //换算成MB  
        loaded=(loaded/1024/1024).toFixed(2);  
        total=(total/1024/1024).toFixed(2);  
        $('#process_info').html(loaded+'M/'+total+'M');  
        $('.upload_current_process').css({'width':percent+'%'});  
    }  
}; 
	
	/** 
	 * 清除上传进度，处理上传失败，上传中断，上传成功 
	 */  
	function clearProcess() {  
	    $('.upload_process_bar,#process_info').hide();  
	    ft.abort();  
	};
	
//var sds = pictureSource.PHOTOLIBRARY;
var pickUrl;		
document.getElementById('album').addEventListener('tap', function() {
		//传递过来的参数
		source = pictureSource.PHOTOLIBRARY;
        navigator.camera.getPicture(function(imageURI){
        		 		var pos = imageURI.lastIndexOf(".");
 				var lastname = imageURI.substring(pos+1,imageURI.length).toLowerCase();
                var largeImage = document.getElementById('smallImage');  
                largeImage.style.display = 'block';
 				if(lastname == "doc"||lastname=="docx"){
               	 	largeImage.src = "images/doc.png";    
 				}else if(lastname=="pdf"){
 					largeImage.src = "images/pdf.png";
 				}else if(lastname=="ppt"||lastname=="pptx"){
 					largeImage.src = "images/ppt.png";
 				}else if(lastname=="xls"||lastname=="xlsx"){
 					largeImage.src = "images/xls.png";
 				}else if(lastname=="zip"){
 					largeImage.src = "images/zip.png";
 				}else if(lastname=="rar"){
 					largeImage.src = "images/rar.png";
 				}else if(lastname=="mp3"||lastname=="aac"||lastname=="wma"||lastname=="wav"||lastname=="wmv"){
 					largeImage.src = "images/mp3.png";
 				}else if(lastname=="cdr"){
 					largeImage.src = "images/crd.png";
 				}else if(lastname=="csv"){
 					largeImage.src = "images/csv.png";
 				}else if(lastname=="txt"){
 					largeImage.src = "images/txt.png";
 				}else if(lastname=="avi"){
 					largeImage.src = "images/avi.png";
 				}else{
                	largeImage.src = imageURI;    
 				}
                pickUrl = imageURI;
            }, function(){  
                if(source==pictureSource.CAMERA)  
                    console.log('加载照相机出错!');  
                else  
                    console.log('加载相册出错!');  
            }, {  
                quality : 50,   
                destinationType : destinationType.FILE_URI,  
                sourceType : source,
                mediaType : mediaType
        });  
    
});

  
/*********上传图片***************/
document.getElementById('uploadFile').addEventListener('tap', function() {
    var imageURI = pickUrl;  
    if(!imageURI)  
        swal('请先选择本地图片');  
    var options = new FileUploadOptions();  
    options.fileKey = "file";  
    options.fileName = imageURI.substr(imageURI.lastIndexOf('/') + 1);  
    options.mimeType = "multipart/form-data";
    options.chunkedMode = false;
    
    var uploadUrl = encodeURI('http://'+serverIp+'/gtims/fileUpload/upload.do?ctype=fybx');   
    var ft = new FileTransfer();  
    ft.upload(imageURI,uploadUrl,uploadSuccess,uploadFailed, options);
    
    //获取上传进度  
    ft.onprogress = uploadProcessing;  
    //显示进度条  
    $('.upload_process_bar,#process_info').show();

}); 

</script>
</body>
</html>