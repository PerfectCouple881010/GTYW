<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv = "X-UA-Compatible" content = "IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=yes" /> 
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<title>贯通综合管理系统-工作管理—工作计划新增</title>
<link href="css/mui.min.css" rel="stylesheet" />
<link href="css/mui.indexedlist.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="css/app.css" />
<link rel="stylesheet" type="text/css" href="css/base.css">
<link rel="stylesheet" type="text/css" href="css/main.css">
<link href="css/mobiscroll.min.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="sweetalert-master/css/sweetalert.css">
<script type="text/javascript" src="sweetalert-master/js/sweetalert.min.js"></script>
<style>
.mui-bar {
	-webkit-box-shadow: none;
	box-shadow: none;
}

#done.mui-disabled {
	color: gray;
}

.mui-table-view-cell.mui-checkbox input[type=checkbox],.mui-table-view-cell.mui-radio input[type=radio] {
	top: 16px;
}
</style>
<!-- <link href="css/common.css" rel="stylesheet" type="text/css" /> -->
</head>
<body>
<div id="offCanvasWrapper" class="mui-off-canvas-wrap mui-draggable">
	<!--侧滑菜单部分-->
	<aside id="offCanvasSide" class="  mui-off-canvas-right" style="background: none">
			<header class="mui-bar mui-bar-nav">
				<a class=" mui-icon mui-icon-left-nav mui-pull-left" id="offCanvasHide"></a>
				<span id="zhHead"></span>
			</header>	
			<div id="offCanvasSideScroll" class="mui-scroll-wrapper">
				<div class="mui-scroll">				
					<div class="mui-content">
						<div id='list' class="mui-indexed-list">
							<div class="mui-indexed-list-search mui-input-row mui-search">
								<input type="search" class="mui-input-clear mui-indexed-list-search-input" placeholder="请输入搜索内容">
							</div>
							<div class="mui-indexed-list-alert"></div>
							<div class="mui-indexed-list-inner">
								<div class="mui-indexed-list-empty-alert">没有数据</div>
								<ul class="mui-table-view" id ="ryList">
									<li class="mui-table-view-cell mui-indexed-list-item mui-checkbox mui-media mui-left">
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</aside>
		<div class="mui-inner-wrap">
<header class="mui-bar mui-bar-nav">
   <!--  <a class="headerL" href="javascript:history.go(-1);"><img src="images/return.png"></a> -->
    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
    <h1 class="mui-title">工作计划新增</h1>
</header>
<div id="offCanvasContentScroll" class="mui-content mui-scroll-wrapper">
				<div class="mui-scroll">
					<div class="mui-content-padded">
		<form class="mui-input-group" id="addJhForm">
        <div class="mui-input-row">
        	<label><span style="color:red">*</span> 计划名称</label>
            <input type="text" placeholder="请输入名称" id="name" validate="*" errorMsg="计划名称必填" placeholder="请输入名称">
            </div>
            <div class="mui-input-row">
              <label><span style="color:red">*</span> 地&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;点</label>
                <input type="text" placeholder="请输入地点" id="planPlace" validate="*" errorMsg="地点必填" placeholder="请输入地点">
            </div>
            <div class="mui-input-row">
                <label><span style="color:red">*</span> 开始时间</label>
                <!-- <input type="text" class="kbtn begin" id="planDate" value=""  validate="*" errorMsg="时间必填" placeholder="请选择日期"> -->
                <input type="text" class="taskAddInput kbtn begin" id="planDate" placeholder="开始日期" validate="*" errorMsg="开始时间必填" readonly="readonly" >
            </div>
            <div class="mui-input-row">
               <label><span style="color:red">*</span> 结束时间</label>
                <!-- <input type="text" class="kbtn end"  id="endDate" validate="d" errorMsg="结束时间不能小于开始时间" placeholder="请选择日期"> -->
                <input type="text" class="taskAddInput kbtn end"  readonly="readonly"  id="endDate" placeholder="结束日期" validate="d" errorMsg="结束时间不能小于开始时间">
            </div>
           <div class="mui-input-row">
            	<label><span style="color:red">*</span> 计划状态</label>
                <select value="" name="planStatus"  id="planStatus" validate="*" errorMsg="计划状态必选">
                 </select>
            </div>
             
            <div class="mui-input-row" id="offCanvasShowXM">
               <label><span style="color:red">&nbsp;</span> 所属项目</label>
               <!-- <select value="" name="projectId" id="projectId"  validate="*" errorMsg="所属项目必选"></select> -->
               <input type="text" class="mui-input  " id="projectName" value="" readonly="readonly" placeholder="请选择所属项目"  errorMsg="所属项目必填">
               <input id="projectId" type="hidden"  name="projectId"  value="" />
               <!-- <a class="mui-navigate-right" id="offCanvasShowXM"  /></a>  -->
            </div>
            <div class="mui-input-row" id="offCanvasShowRW">
               <label><span style="color:red">&nbsp;</span> 所属任务</label>
            	   <!-- <select value="" name="goalId" id="goalId" validate="*" errorMsg="所属任务必选"></select> -->
            	   <input type="text" class="mui-input  " id="goalName" value="" readonly="readonly" placeholder="请选择所属任务" validate="" errorMsg="所属任务必填">
               	  <input id="goalId" type="hidden"  name="goalId"  value="" /> 
               	  <!-- <a class="mui-navigate-right" id="offCanvasShowRW"  /></a> -->
            </div>
		 
		 <div class="mui-input-row" id="offCanvasShow">
            <label><span style="color:red">*&nbsp;</span>参&nbsp;与&nbsp;人</label>
            <input type="text" class="mui-input  " id="participants" value="" readonly="readonly" placeholder="请选择联系人" validate="*" errorMsg="联系人必填">
            <input id="participantids" type="hidden"  name="participantids"  value="" />
            <!-- <a class="mui-navigate-right" id="offCanvasShow"  /></a> -->
		 </div>
		 <div class="mui-input-row">
            <label><span style="color:red"></span>计划描述</label>
        </div>
        <textarea placeholder="请输入详细机会描述" id="description"></textarea>
    <div class="mui-button-row" style="height:57px">
		<div class="DetailBotBtn1 DetailBotBtn2">       
			<a  class="back header_button  mui-action-back">取消新增</a>
			<a href="javascript:void(0);" class="newproject header_button" id="tijiao">确认新增</a>
		</div>
	</div>	   
</form>
</div></div></div></div>
</div>
  
<div id="datePlugin"></div>    
<script type="text/javascript" src="js/jquery-1.9.1.js" ></script>
<!-- <script type="text/javascript" src="js/date.js" ></script> -->
<script type="text/javascript" src="js/iscroll.js" ></script>
<script src="js/mobiscroll.min.js"></script>
<script>
$(function(){
	$('#planDate').mobiscroll().datetime({theme: 'android-holo-light', lang: 'zh',display: 'bottom'});
	$('#endDate').mobiscroll().datetime({theme: 'android-holo-light', lang: 'zh',display: 'bottom'});
      
});
</script>
<script src="lib/jquery-2.1.4.min.js"></script>
<script src="js/mui.min.js"></script>
<script src="js/mui.indexedlist.js"></script>
<script src="js/app.js"></script>
<script type="text/javascript" src="js/index.js"></script>
<script type="text/javascript" src="js/initInfo.js"></script>
 <!-- Mobiscroll JS and CSS Includes -->
<script src="js/mobiscroll.min.js"></script>

<script type="text/javascript">
mui.init({gestureConfig: {
	tap: true,
	doubletap: false,
	longtap: false,
	hold: false,
	flick: true,
	swipe: true,
	drag: true,
	pinch: false
}	,swipeBack:false //启用右滑关闭功能
});
	//$(function () {});
			mui.ready(function() {
			intiBaseByType(serverIp,"sid","currentIntent","/dataDir/listName.do","yxz");
	  var userId =localStorage.getItem("id");
			$('#chargerNameId').val(userId);
			//getxmList();
		  //侧滑容器父节点
			var offCanvasWrapper = mui('#offCanvasWrapper');
			 //主界面容器
			var offCanvasInner = offCanvasWrapper[0].querySelector('.mui-inner-wrap');
			 //菜单容器
			var offCanvasSide = document.getElementById("offCanvasSide");
			if (!mui.os.android) {
				var spans = document.querySelectorAll('.android-only');
				for (var i = 0, len = spans.length; i < len; i++) {
					spans[i].style.display = "none";
				}
			}
			//主界面‘显示侧滑菜单’按钮的点击事件--参与人 
			document.getElementById('offCanvasShow').addEventListener('tap', function() {
				var title='<h1 class="mui-title">选择人员</h1>'+
				'<a id="done" class="mui-btn mui-btn-link mui-pull-right mui-btn-blue mui-disabled">完成</a>';
				document.querySelector('#zhHead').innerHTML = title;
				getLinkManList();
				offCanvasWrapper.offCanvas('show');
				var header = document.querySelector('header.mui-bar');
				var list = document.getElementById('list');
				var done = document.getElementById('done');
				//calc hieght
				//list.style.height =(document.body.offsetHeight - header.offsetHeight) + 'px';
				list.style.height = '100%';
				//create
				window.indexedList = new mui.IndexedList(list);
				//done event
				done.addEventListener('tap', function() {
					var checkboxArray = [].slice.call(list.querySelectorAll('input[type="checkbox"]'));
					var checkedValues = [],ryids=[];
					checkboxArray.forEach(function(box) {
						if (box.checked) {
						   //checkedValues.push(box.parentNode.innerText);
						   checkedValues.push(box.getAttribute("ryname"));
							ryids.push(box.value);
						}
					});
					if (checkedValues.length > 0) {
					//mui.alert('你选择了: ' + checkedValues );
					document.getElementById('participants').value=checkedValues;
					document.getElementById('participantids').value=ryids;
					offCanvasWrapper.offCanvas('close');
					 } else {
						mui.swal('你没选择任何人员');
					}
					
				}, false);
				mui('.mui-indexed-list-inner').on('change', 'input', function() {
					var count = list.querySelectorAll('input[type="checkbox"]:checked').length;
					var value = count ? "完成(" + count + ")" : "完成";
					done.innerHTML = value;
					if (count) {
						if (done.classList.contains("mui-disabled")) {
							done.classList.remove("mui-disabled");
						}
					} else {
						if (!done.classList.contains("mui-disabled")) {
							done.classList.add("mui-disabled");
						}
					}
				});
			});
			//主界面‘显示侧滑菜单’按钮的点击事件 ---项目
			document.getElementById('offCanvasShowXM').addEventListener('tap', function() {
				var title='<h1 class="mui-title">选择项目</h1>'+
				'<a id="done" class="mui-btn mui-btn-link mui-pull-right mui-btn-blue mui-disabled">完成</a>';
				document.querySelector('#zhHead').innerHTML = title;
				getxmList();
				offCanvasWrapper.offCanvas('show');
				var header = document.querySelector('header.mui-bar');
				var list = document.getElementById('list');
				var done = document.getElementById('done');
				//calc hieght
				//list.style.height =(document.body.offsetHeight - header.offsetHeight) + 'px';
				list.style.height = '100%';
				//create
				window.indexedList = new mui.IndexedList(list);
				//done event
				done.addEventListener('tap', function() {
					var projectId = $("input[name='radio']:checked").val();
					var projectName = $("input[name='radio']:checked").attr("ryname");
					if (projectId > 0) {
					document.getElementById('projectName').value=projectName;
					document.getElementById('projectId').value=projectId;
					offCanvasWrapper.offCanvas('close');
					 } else {
						mui.swal('你没选择任何项目');
					}
					
				}, false);
				mui('.mui-indexed-list-inner').on('change', 'input', function() {
					var count = list.querySelectorAll('input[type="radio"]:checked').length;
					var value = count ? "完成(" + count + ")" : "完成";
					done.innerHTML = value;
					//mui.alert('你选择了: ' + radiovalue );
					if (count) {
						if (done.classList.contains("mui-disabled")) {
							done.classList.remove("mui-disabled");
						}
					} else {
						if (!done.classList.contains("mui-disabled")) {
							done.classList.add("mui-disabled");
						}
					}
				});
			});
			//主界面‘显示侧滑菜单’按钮的点击事件 ---任务
			document.getElementById('offCanvasShowRW').addEventListener('tap', function() {
				var title='<h1 class="mui-title">选择任务</h1>'+
				'<a id="done" class="mui-btn mui-btn-link mui-pull-right mui-btn-blue mui-disabled">完成</a>';
				document.querySelector('#zhHead').innerHTML = title;
				getrwList();
				offCanvasWrapper.offCanvas('show');
				var header = document.querySelector('header.mui-bar');
				var list = document.getElementById('list');
				var done = document.getElementById('done');
				//calc hieght
				//list.style.height =(document.body.offsetHeight - header.offsetHeight) + 'px';
				list.style.height = '100%';
				//create
				window.indexedList = new mui.IndexedList(list);
				//done event
				done.addEventListener('tap', function() {
					var projectId = $("input[name='radio']:checked").val();
					var projectName = $("input[name='radio']:checked").attr("ryname");
					if (projectId > 0) {
					document.getElementById('goalName').value=projectName;
					document.getElementById('goalId').value=projectId;
					offCanvasWrapper.offCanvas('close');
					 } else {
						mui.swal('你没选择任务');
					}
					
				}, false);
				mui('.mui-indexed-list-inner').on('change', 'input', function() {
					var count = list.querySelectorAll('input[type="radio"]:checked').length;
					var value = count ? "完成(" + count + ")" : "完成";
					done.innerHTML = value;
					//mui.alert('你选择了: ' + radiovalue );
					if (count) {
						if (done.classList.contains("mui-disabled")) {
							done.classList.remove("mui-disabled");
						}
					} else {
						if (!done.classList.contains("mui-disabled")) {
							done.classList.add("mui-disabled");
						}
					}
				});
			});
			 //菜单界面，‘关闭侧滑菜单’按钮的点击事件//
			document.getElementById('offCanvasHide').addEventListener('tap', function() {
				offCanvasWrapper.offCanvas('close');
			});
				

intiBaseByType(serverIp,"pStatus","planStatus","/dataDir/listName.do","jhzt");//planStatus
var userName =localStorage.getItem("nickname");
var userId =localStorage.getItem("id");
var tjButton = document.getElementById('tijiao');
tjButton.addEventListener('tap', function(event) {

$('#createrId').val(userId);
$('#modifyPersonId').val(userId);
	var tjInfo = $("#addJhForm").serializeJson();
	console.log(tjInfo)
	app.addChance(tjInfo, function(err) {
		/* if (err) {
			mui.toast(err);
			return;
		} */
		//validateForm验证
		var result = true;
		$("form input[type='text']").each(function(){
			if($(this).attr("validate")!=null&&!validateForm($(this))){
				result = false;
				return result;
			}
			
		});
		if(result != false){
		$("select").each(function(){
			if($(this).attr("validate")!=null&&!validateForm($(this))){
				result = false;
				return result;
			}
		});}
		//提交后台新增
		if(result){
		$.ajax({
			type:'post',
			traditional:true,
			url: 'http://'+serverIp+'/gtims/plan/insertForPhone.do',
			data: {'createrId':userId,'modifyPersonId':userId,'name':$('#name').val(),
			    'participants':$('#participantids').val(),
				'planPlace':$('#planPlace').val(),
				'planDate':$('#planDate').val(),
				'endDate':$('#endDate').val(),
				'planStatus':$('#planStatus').val(),
				'projectId':$('#projectId').val(),
				'goalId':$('#goalId').val(),
				'description':$('#description').val()},
			dataType: 'json',
			crossDomain: true,	
			success: function(data) {
				location.href='workManagePlan.html';
				//mui.back()
			},
			error:function(msg){
				swal("访问出错！");
			}
		});
		}
	});
});
//participants.value = userName ;
	 //主界面和侧滑菜单界面均支持区域滚动；
			mui('#offCanvasSideScroll').scroll();
			mui('#offCanvasContentScroll').scroll();
			 //实现ios平台原生侧滑关闭页面；
			if (mui.os.plus && mui.os.ios) {
				mui.plusReady(function() { //5+ iOS暂时无法屏蔽popGesture时传递touch事件,直接屏蔽popGesture功能
					plus.webview.currentWebview().setStyle({
						'popGesture': 'none'
					});
				});
			}
			
			});
	//查询参与人
	function getLinkManList() {
			$.ajax({
				url: 'http://'+serverIp+'/gtims/user/findSelectMember.do?userId='+localStorage.getItem("id"),
				async: false,
				data:{'start':'0','end':'10000'},
				dataType: 'json',
				crossDomain: true,
				success: function(data) {
				 var html = "",obj=data.data;
					for (var i = 0; i < obj.length; i++) {
					    html+='<li class="mui-table-view-cell mui-indexed-list-item mui-checkbox mui-media mui-left">'+
						'<input type="checkbox" value="'+obj[i].id+'" ryname="'+obj[i].nickname+'" /> '+
									'<img class="mui-media-object mui-pull-left" src="images/linkman.png">'+
										'<div class="mui-media-body mui-ellipsis">'+obj[i].nickname+'('+obj[i].orgIdShow+')'+
											'<p class="mui-ellipsis">'+obj[i].phone+'</p>'+
										'</div></li>';
					}
				document.querySelector('#ryList').innerHTML = html;
			}
			});
				}
			//查询项目	
				function getxmList() {
					$.ajax({
				url: 'http://'+serverIp+'/gtims/project/list.do?userId='+localStorage.getItem("id"),
				async: false,
				data:{'start':'0','end':'10000'},
				dataType: 'json',
				crossDomain: true,
				success: function(data) {
				 var html = "",obj=data.data;
					for (var i = 0; i < obj.length; i++) {
					    html+='<li class="mui-table-view-cell mui-indexed-list-item mui-radio mui-media mui-left">'+
						'<input type="radio"  name="radio"  value="'+obj[i].id+'" ryname="'+obj[i].name+'" /> '+
										'<div class="mui-media-body mui-ellipsis">'+obj[i].name+'('+obj[i].projectManagerShow+')'+
											'<p class="mui-ellipsis">'+obj[i].projectStatusShow+'</p>'+
										'</div></li>';
					}
				document.querySelector('#ryList').innerHTML = html;
			}
			});
				}
			//查询任务 	
			function getrwList() {
					$.ajax({
				url: 'http://'+serverIp+'/gtims/goal/list.do?userId='+localStorage.getItem("id"),
				async: false,
				data:{'start':'0','end':'10000'},
				dataType: 'json',
				crossDomain: true,
				success: function(data) {
				 var html = "",obj=data.data;
					for (var i = 0; i < obj.length; i++) {
					    html+='<li class="mui-table-view-cell mui-indexed-list-item mui-radio mui-media mui-left">'+
						'<input type="radio"  name="radio"  value="'+obj[i].id+'" ryname="'+obj[i].name+'" /> '+
										'<div class="mui-media-body mui-ellipsis">'+obj[i].name+'('+obj[i].chargerNameShow+')'+
											'<p class="mui-ellipsis">'+obj[i].goalTypeShow+'</p>'+
										'</div></li>';
					}
				document.querySelector('#ryList').innerHTML = html;
			}
			});
				}
	 	//结束时间不能小于开始时间
	 /* 	function vali_Date()  
	 	{  
	 	    var start = $("#planDate").val();  
	 	    var end = $("#endDate").val();
	 	        if(end<start){  
	 	            alert('结束时间不能小于开始时间！');  
	 	            $("#endDate").focus();  
	 	            return false;  
	 	        }  
	 	    return true;  
	 	}  */
</script>
</body>
</html>        
      
    



			